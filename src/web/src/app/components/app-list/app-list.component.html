<ng-template #$loading
             let-apps>
  <app-wait *ngIf="apps===null"></app-wait>
</ng-template>

<ng-container *ngIf="appVersionMap$|async as versionMap;else $loading">
  <ng-container *ngIf="appJobMap$|async as appJobMap;else $loading">
    <div class="appList"
         *ngIf="appList$|async as $apps;else $loading">
      <div class="app"
           [attr.index]="$index+1"
           [class.index]="rankIndex"
           *ngFor="let $app of $apps;index as $index"
           appHover
           #$appContent="appHover">
        <div class="cover"
             [routerLink]="$app.name">
          <img [src]="server+'/'+([$app.localInfo.images.cover,$app.localInfo.images.coverHD]|fitImage)">
        </div>
        <div class="content">
          <div class="info"
               *ngIf="!$appContent.Hover || !$app.version;else $appControl">
            <div class="name">{{$app.localInfo.description.name}}</div>
            <div class="subtitle"
                 [ngSwitch]="subtitle">
              <div>
                <span *ngSwitchCase="'category'"
                      class="category">{{$app.localCategory}}</span>
                <span *ngSwitchCase="'slogan'">
                  {{$app.localInfo.description.slogan}} &nbsp;
                </span>
              </div>
              <dstore-star [rate]="$app.rate"></dstore-star>
            </div>
          </div>
          <!-- <div class="info ellipsis"
               [routerLink]="$app.name"
               [attr.index]="rankIndex?$index+1+'.':''"
               [attr.data-title]="$app.localInfo.description.name">
            <div [ngSwitch]="subtitle"
                 class="subtitle">
              <span *ngSwitchCase="'category'"
                    [routerLink]="['/category',$app.category]">{{$app.localCategory}}</span>
              <span *ngSwitchCase="'slogan'">
                {{$app.localInfo.description.slogan}} &nbsp;
              </span>
            </div>
          </div> -->
          <!-- <div class="star"
               *ngIf="!$appContent.Hover || !$app.version;else $appControl">
            <dstore-star [rate]="$app.rate"></dstore-star>
          </div> -->
          <ng-template #$appControl>
            <div class="info">
              <div class="title">
                <span class="name"
                      [routerLink]="$app.name">{{$app.localInfo.description.name}}</span>
              </div>
              <div class="subtitle"
                   [ngSwitch]="subtitle">
                <div>
                  <span *ngSwitchCase="'category'"
                        class="category"
                        [routerLink]="['/category',$app.category]">{{$app.localCategory}}</span>
                  <span *ngSwitchCase="'slogan'"
                        [routerLink]="$app.name">
                    {{$app.localInfo.description.slogan}} &nbsp;
                  </span>
                </div>
              </div>
            </div>

            <div class="control">
              <ng-template #ctlBtn
                           let-$job>
                <ng-container *ngIf="versionMap[$app.name] as $version">
                  <ng-container #$btnGroup
                                *ngIf="$job!==null">
                    <button *ngIf="!$version.localVersion && $version.remoteVersion"
                            (click)="installApp($app.name)"
                            i18n>Install</button>
                    <button *ngIf="$version.localVersion && !$version.upgradable"
                            (click)="openApp($app.name)"
                            i18n>Open</button>
                    <button *ngIf="$version.upgradable"
                            (click)="updateApp($app.name)"
                            i18n>Update</button>
                  </ng-container>
                </ng-container>
              </ng-template>

              <ng-container *ngIf="appJobMap[$app.name];else ctlBtn">
                <svg width="2rem"
                     height="2rem"
                     class="controlBtn"
                     *ngIf="appJobMap[$app.name]|async as $job">
                  <ng-container *ngIf="$job.type=='download'"
                                [ngSwitch]="true">
                    <image [attr.xlink:href]="'/assets/buttons/pause_'+($job.cancelable?'normal':'insensitive')+'.svg'"
                           width="100%"
                           height="100%"
                           *ngSwitchCase="$job.status=='running' || $job.status=='ready'"
                           (click)="pause($job.job)"></image>
                    <image [attr.xlink:href]="'/assets/buttons/start_'+($job.cancelable?'normal':'insensitive')+'.svg'"
                           width="100%"
                           height="100%"
                           *ngSwitchCase="$job.status=='paused'"
                           (click)="start($job.job)"></image>
                  </ng-container>
                  <circle cx="50%"
                          cy="50%"
                          r="45%"
                          stroke="black"
                          stroke-opacity="0.05"
                          stroke-width="3"
                          fill="none" />
                  <circle cx="50%"
                          cy="50%"
                          r="45%"
                          stroke="#378cfa"
                          stroke-width="3"
                          fill="none"
                          [style.transform-origin]="'center'"
                          [style.transform]="'rotate(-90deg)'"
                          attr.stroke-dasharray="calc( 2rem*3.14*{{$job.progress*2}} ) calc( 2rem * 3.14 * 2 )"></circle>
                </svg>
              </ng-container>
            </div>
          </ng-template>
        </div>
      </div>
      <div class="app"
           [style.height]="0"
           *ngFor="let a of [1,2,3,4,5,6]"></div>
    </div>
    {{offset$|async}}
  </ng-container>
</ng-container>